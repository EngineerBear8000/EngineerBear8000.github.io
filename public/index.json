[{"content":"\u003cp\u003eDuring my \u003cimg src=\"/internship-at-fabrica\" alt=\"Internship at Fabrica.AI\"\u003e, I also participated in the planning for the next robot version V5. The primary purpose of V5 was to increase the modularity of the robot such that each module could be replaced without influencing other modules. This was done so as decouple the development of the modules such that incremental upgrades could be done instead of having to embark on a costly and risky full redesign every year. It is meant to be the overhaul to end overhauls. At the same time, electrically the major changes would be\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003ea shift to brushless motors\u003c/li\u003e\n\u003cli\u003ethe consolidation of most daughter PCBs into the main PCB\u003c/li\u003e\n\u003cli\u003eFurther reduction in noise and increase in reliability.\nDuring my time as an intern, the company was tried to find a suitable full time electrical engineer to do bring V5 into fruition. But after months of searching were still unable to find someone. As such, my boss Jakub decided to offer me the position instead. This meant that I would have to take a year off my studies. Despite some resistance from family and friends, I eventually decided to take on the offer. I felt like it was a good opportunity to take a break from the one and done style of school projects. This job would allow me to dig deeper into the world of electronics, finding root cause of issues and understanding the fine details of real world design. And indeed it did!\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"shift-to-brushless-motors\"\u003eShift to brushless motors\u003c/h2\u003e\n\u003cp\u003eI proposed the shift to brushless motors because when paired with good drivers that output sinusoidal waveforms, they would produce less EMC and EMI as compared to brushed motors. There is also the added benefit of much higher power density which allows for higher operating speeds which a secondary goal of V5. I helped to look for a cost effective supplier that offered drivers which communicate by a differential signal such as RS485, CAN Bus or Modbus. We ended up settling on Kinco as they were cost effective and offered a CANbus solution.\u003c/p\u003e\n\u003ch2 id=\"consolidation-of-pcbs\"\u003eConsolidation of PCBs\u003c/h2\u003e\n\u003cp\u003eThe V4 electronics box was composed of many sub pcbs. Their physical arrangement and mating was also sub optimal, interfacing at different layers and at orthogonal angles with headers. This not only made electrical signaling poor due to large ground loops but also mechanical interfacing with the enclosure poor as the stacking of multiple boards made tolerancing poor. By consolidating the boards it would also made assembly simpler.\u003cbr\u003e\n![[IMG_20240220_172147.jpg]]\ncomparison of V4 and V5 PCBs and electronics drybox.\u003c/p\u003e\n\u003ch2 id=\"further-reducing-noise-and-increasing-reliability\"\u003eFurther reducing noise and increasing reliability\u003c/h2\u003e\n\u003cp\u003eAfter the experience of partially redesigning V4 and characterizing its performance, I strove to further improve the design for V5.\nOne particular area of noise emission that was particularly interesting to tackle was the LED driver. Although, I did optimise the layout in V4, I could tell it was still a source of noise that was influencing components around it. Using the spectrum analyser with H and E field probes, there were clearly emissions coming from the led drivers. With the oscilloscope, 300mV Vpp spikes occurring at the switching frequency ~550kHz are clearly visible.\n\u003cimg src=\"/led_spikes.png\" alt=\"led spikes\"\u003e\n\u003cimg src=\"/spike_close.png\" alt=\"spike close\"\u003e\u003c/p\u003e\n\u003cp\u003eIt took awhile to understand the issue, but with the help of LTspice simulation, I finally found out that the schottky diode I was using had a very high junction capacitance. The junction capacitance acts like a short circuit to ground for a short instant when the LED driver\u0026rsquo;s mosfet turned on. The larger the capacitance, the larger the current spike, this spike then induces ringing with the other circuit parasitics. A new diode was chosen with a much lower capacitance and paired with RCD dampers to absorb the residual oscillations, much better performance was recorded.\n\u003cimg src=\"/led_after.png\" alt=\"led_after\"\u003e \u003cimg src=\"/led_after_close.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eAnother interesting design challenge was the hotswap controllers for the motor driver power supply. It is a high side controller IC that drives an N channel mosfet to provide protection features such as OCP, OVP, ULVO and softstart. Initial design was relatively easy and the first revision worked as expected. However, 1/5 boards encountered an issue where the mosfet died right before robot commissioning. I replaced the mosfet and carried on but a couple weeks later it happened again. This called for a deeper investigation which lasted a month. I made many measurements with the oscilloscope to ensure that there were no voltage spikes, gate ringing, etc. Finally, it was found that the SOA of the mosfets were not good enough. Specifically at the spirito effect region of high Vds and high current that occurs during startup. Due to that mosfet being older and more optimised for fast switching, the current ability at high Vds was only 2A. When measured, the startup current was ~20A for about 100us. A new mosfet was chosen, a gate capacitor was added to linearise the inital capacitor charging which solved the issue.\u003c/p\u003e\n\u003ch2 id=\"production-of-first-v5-robot-in-shenzhen\"\u003eProduction of first V5 robot in Shenzhen\u003c/h2\u003e\n\u003cp\u003eAfter the initial design phase was complete, it was time for the final production and assembly of the V5 robot. Since I was decently proficient not only in electronics design but also mechanical and had some experience in software, I was designated to fly to china for 2 weeks to oversee the production of the first V5 robot. Collaborating with the mechanical and software team back in Singapore, I helped to resolve design issues, alleviate production bottlenecks and documented the assembly process for further review.\u003c/p\u003e\n\u003cp\u003eThis information was then used to update the design with design for manufacturing and assembly in mind. I also proposed optimisations to the assembly instructions to reduce assembly error and improve consistency. I was then given another opportunity to oversee the production of the last few robots in the second production run. Due to the improvements in design and assembly processes, this run was much smoother. Delivery was on time, final assembly and integration in Singapore took only 2 days compared to the weeks it took for the robots in the first run.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/shenzhen.jpg\" alt=\"Shenzhen\"\u003e\u003c/p\u003e\n\u003cp\u003eAll in all I found my experience as an electrical engineer at Fabrica very rewarding, it has increased my interest to dive deeper into electronics engineering.\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:1313/blog/electrical-engineer-at-fabrica/","title":"Electrical Engineer at Fabrica.AI"},{"content":"\u003cp\u003eIt was interesting and fun to intern at Fabrica. Being a small startup, work there was very fast paced. Since I did relatively well at the interview, many of the full timers also put more trust and responsibility on me. As such I was able to work on many interesting problems that pushed my knowledge and understanding further.\u003c/p\u003e\n\u003cp\u003eDuring my time there, I helped solve a couple of issues which helped increase the robot\u0026rsquo;s reliability that eventually allowed it to enter into consistent site deployment.\u003c/p\u003e\n\u003cp\u003eThe biggest issue was electrical noise. The robot was experiencing many random component failures which was suspected to be caused by electrical noise. When the approach of applying general RC filtering didnt help, more investigation was conducted. It was quickly found that the noise was extremely high throughout the whole robot and as such I convinced my boss that a complete reimplementation was required to solve these issues.\u003c/p\u003e\n\u003ch2 id=\"electronics-redesign\"\u003eElectronics redesign\u003c/h2\u003e\n\u003cp\u003eDelving deeper into the design files, I found several issues that were common causes for noise propagation in PCBs.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eThe main PCB was a 2 layer board despite being relatively complex and large. This meant that there was no solid ground plane beneath the signal traces for a proper low impedance return path. As such the electromagnetic fields would spread very far and the fields of different signals would cross couple causing interference.\u003c/li\u003e\n\u003cli\u003eSignals were routed very close together, despite ample space for distribution. Ideally traces should be placed 3 trace widths apart for minimal cross coupling between the fields of adjacent traces.\u003c/li\u003e\n\u003cli\u003eConnectors to daughter board lacked enough direct ground connections. This again causes long return path loops which increase noise.\u003c/li\u003e\n\u003cli\u003eThe robot used brushed motors which were controlled by PWM and were inherently noisy.\u003c/li\u003e\n\u003cli\u003eSwitching LED driver layout was not optimal which increases emits more noise.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThe full redesign took steps to fix all of these issues\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eRe-route all traces for the mainboard to be on 4 layers instead of 2. 4 Layers allows both inner layers to be full ground planes, additionally the distance between the signal and ground planes is significantly lower in a 4L board than a 2L board(1.2mm vs 0.2mm) reducing the field spread massively.\u003c/li\u003e\n\u003cli\u003eRouting was done with sound best practices such as spacing traces apart, adding grounding vias beside signal vias, minimising loop inductance.\u003c/li\u003e\n\u003cli\u003eWhere available unused pins were repurposed to become ground pins for daughter board connections.\u003c/li\u003e\n\u003cli\u003ePower filtering was added to reduce the transmission of switching EMC from the motors to the rest of the system. Adding capacitors to the power path and ferrites to dissipate high frequency noise. Common mode chokes were also explored.\u003c/li\u003e\n\u003cli\u003eThe layout was changed to make switching loop impedance minimization the highest priority. The flyback diode was also changed to a schottky diode to fix another problem with occasional LED driver failures. The external flyback diode used needs to have a lower forward voltage than mosfet body diode, otherwise the body diode is preferentially forward biased and takes all the flyback load.\u003c/li\u003e\n\u003cli\u003eAdditionally by the advice of consultants, harness were redesigned with shielding to reduce EMI from motor cables and improve shielding of signals. This was something I initally totally overlooked as I was too focused on tackling the issues with the PCB.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eI did the bom sourcing and helped to manage the production of this new batch of pcbs which were delivered towards the end of my 3.5 month internship. I was actually quite nervous during this time as I only knew these concepts on a theoretical basis. Up till that point, I havent actually done routing for such a complex system before. I didnt know how much of difference these measures would make in practice. Fortunately after complete testing of the new electronics, my understanding was validated. There was a 4x reduction in noise from the previous design.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/old_shieldedharness_duty10_opp.png\" alt=\"old loadcell\"\u003e\n\u003cimg src=\"/newpcb_shieldedharness_duty10_opp.png\" alt=\"new loadcell\"\u003e\nLoadcell readings which are highly sensitive to noise. Old is above and new below. The old design had much larger spread of readings. Below is much cleaner, with occasional far points that can easily be filtered in code.\u003c/p\u003e\n\u003ch2 id=\"bug-squashing-team\"\u003eBug squashing team\u003c/h2\u003e\n\u003cp\u003eThe second major contribution was the participation in the bug squashing team. It was composed of full time employees but I was given the privilege to join due to their trust in me. Efforts were focused on investigating the root causes of bugs, proposing solutions, and implementing permanent fixes. This approach aimed at enhancing the overall robustness of the tile grouting robot by addressing underlying technical or procedural issues. Weekly cross-department meetings provided a platform to collectively address more complex problems.\u003c/p\u003e\n\u003cp\u003eOne issue I am particularly proud of was the resolution of a long standing issue with the short lifetime of motor encoders. It was originally thought of as an electrical issue.  But through some discussion and careful observation by the lead mechanical designer, it was eventually identified to be a mechanical misalignment of the shaft and the encoder. Despite this, a good solution was not found as the 3D printed mount used could not be produced with the right tolerance to provide a tight enough fit.  This inspired me to design an adapter PCB with soldered threaded inserts to for the purpose of holding the encoder rigidly and concentrically. The PCB was also used to add ceramic capacitors to help with the ongoing noise issues. Since this PCB was very small and simple, it was also very cheap to produce and provided a more compact mounting solution than before. I felt that this was a very clean solution to a cross department problem that was effectively solved through my participation in the bug squashing team.\u003c/p\u003e\n\u003cp\u003eAfter a period of time, many such issues were resolved which brought the version 4 robot to a state of reliability where multiple robots could be consistently deployed weekly to the construction site. Before it would only be brought there for a week before big demos or for short testing. This gave us valuable insight into the deployment and operational challenges that were not obvious before during short deployments.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/IMG_20231107_145203.jpg\" alt=\"inten_happy\"\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:1313/blog/internship-at-fabrica/","title":"Intern at Fabrica.AI"},{"content":"\u003cp\u003eThis was a small project I did for thermodynamics module in Y2 of Uni. The premise is simple, heated beds of printers need to be heated for optimal printing quality. To perform their function properly, they have to be constantly heated for long periods of time, however long the print is. This is compounded by the size of the heated bed or if it is used to heat the chamber as well. A print could easily last 12h and draw around 50-100w. Sure, insulation may help but nothing beats a little heat pump action!\u003c/p\u003e\n\u003cp\u003eHeat pumps as their namesake, use some energy to move heat from one place to another. This allows them to achieve \u0026gt;100% efficiency with respect to the electrical energy input into the device. I decided to use a peltier as the heat pump. Although it only has a COP of ~2 compared to full cycle compressors, it is compact and easy to work with. The timeline for this project was only about 2 weeks which would make it unrealistic to integrate more sophisticated heat pumps. A peltier is also more compact and has an ideal form factor to fit onto a heated bed. The idea was that instead of using the peltier to provide cooling like it\u0026rsquo;s usually used, I can use the other side to heat the heated bed.\u003c/p\u003e\n\u003cp\u003eHere comes the most elegant part about this idea, the cold side of the peltier can be used to cool air for various parts around the printer that requires cooling! There will be a heatsink on the cold side of the peltier to aid in heat transfer into the device. Air will be blown over it to further increase efficiency, that colder air can then be used to cool electronics or channeled to the part cooling duct.\n\u003cimg src=\"/elegant_meme.png\" alt=\"elegant meme\"\u003e\u003c/p\u003e\n\u003cp\u003eThe actual design and construction of the project was fairly straightforward. I drew up a CAD model of the device, an aluminum plate (100x100mm) identical to that of my old 3d printer acts as the heated bed. An adheasive sticker is placed on top to ensure equivalent thermal properties. To spread the heat from the 40x40mm peltier over the whole bed area, 4 heatpipes are placed diagonally. An aluminum spacer the thickness of the heatpipes and size of the peltier is used for increase contact area. Finally, below that is the peltier and its heatsink on the other side. A radial fan blows air over the heatsink in a duct.\u003c/p\u003e\n\u003cp\u003eThe aluminum plate and spacer were cut on the waterjet in school. The duct was 3d printed on my printer. All that was left was a little assembly with screws and thermal paste at every interface to ensure proper heat transfer. This was fairly straightforward and took about a day. Afterwhich, my team and I moved on to testing of the device in comparison with a normal heated bed.\n\u003cimg src=\"/peltier_bed.jpg\" alt=\"peltier bed\"\u003e\n\u003cimg src=\"/peltier_heating1.jpg\" alt=\"peltier thermal\"\u003e\u003c/p\u003e\n\u003cp\u003eThe test setup was as such, I would power both devices at 100W to heat up to operating temperature of 60c. Then the power would be reduced to the level which with it would be at steady state. This power level would be used to compare both devices.\u003c/p\u003e\n\u003cp\u003eUnfortunately, the peltier heater was not more efficient then the normal resistive bed. The measurements of power consumption was close enough to be within margin of error. After the initial disappointment wore off, I reflected on why this could be the case. I surmised that it was because the conduction from the hotside of the peltier to the cold side would causes the majority of the losses in efficiency. This would be especially pronounced at steady state as the heat would have plenty of time to propagate back. The ideal solution to this would be to use a different heat pump such as a compressor cycle heat pump. This would completely decouple the hot and cold sides preventing parasitic backwards heat transfer.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/peltier_sandwich.jpg\" alt=\"peltier thermal\"\u003e\n\u003cimg src=\"/peltier_heating2.jpg\" alt=\"peltier thermal\"\u003e\u003c/p\u003e\n\u003cp\u003eTo validate this hypothesis and salvage the project, we decided to compare the 2 systems in a fastest time to heat test instead. Both devices were heated at the same power of 60W and the time taken to heat to 60 degrees from room temperature was taken. This way, conduction effects would be less dominant vs the heating effects. Fortunately, this hypothesis proved to be correct and the peltier heater heated significantly quicker(X) than the resistive bed (X). We presented our findings to our professors in the final presentation where we did well because of the novel idea which appropriately implemented concepts from the course content. (We got 9/10üéâ).\u003c/p\u003e\n\u003cp\u003eIn reflection, it was quite a fun project that has a very interesting premise. As usual it was held down by sub optimal implementation. It was a good proof of concept though. I did know about issues of peltier having back conduction problems but didnt know how much of a problem that would or pose. The interesting thing about this project is that the larger the scale, the more it makes sense. With a large printer it then becomes feasible to be use compressor cycle heat pumps that will work effectively. Especially with extremely large format 3D printers becoming available and popular such as \u0026gt;600mm cube volumes, not only does the power draw and thus the potential savings increase, the print time also scales up dramatically. At my current internship office the bed of the Modix printer 600mm cube printer uses a 1kw ac heater. Imagine the savings!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:1313/blog/peltier/","title":"Peltier 3D Printer Bed"},{"content":"\u003cp\u003eWhere do I even start? Ive been taking part in SAFMC for 8 years at that point in time. Originally in Category C and after that in D1. I am personally very proud of this achievement as it brought together all of the knowledge and skills I have acquired in the years prior.\u003c/p\u003e\n\u003cp\u003eThe challenge was similar to that we had been working on for the previous few years, with a couple of notable additions. It goes as follows, 2 teams fly their drones semi autonomously(through FPV systems). They play tic tac toe in real time against one another by picking up beanbags from the starting area and placing them on a grid at the other end of the playfield.\n\u003cimg src=\"/safmc2021_playfield.png\" alt=\"safmc2021_playfield\"\u003e\u003c/p\u003e\n\u003cp\u003eThe crucial new additions were that only specific shaped beanbags can claim specific tiles on the tic tac toe grid. Square tiles claim the north south east and west tiles, pyramid beanbags claim the diagonal tiles and the middle tile can only be claimed by the eraser.\n\u003cimg src=\"/safmc2021_tiles.png\" alt=\"safmc2021_tiles\"\u003e\nMost teams usually relied heavily on pilot skill to overcome the challenge. However, knowing that we were not the most skilled pilots out there, we chose to tackle the challenge in a highly technical way, making everything as automated as possible.\n\u003cbr\u003e\n\u003cbr\u003e\nI led a team of 3 to design a drone system to autonomously pickup payload, and fly through an obstacle course and deliver them to a tic tac toe playfield against opponents in real time. I was the team lead and architected the major systems required to complete the challenge competitively. Including\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003ea lightweight and efficient drone that is capable of operating for 10 minutes while carrying the payload.\u003c/li\u003e\n\u003cli\u003eA companion holonomic platform to perform payload delivery to the drone fully autonomously with failsafe feedback mechanisms.\u003c/li\u003e\n\u003cli\u003eA computer vision system to detect opponent moves and assist the pilot by computing the optimal move to win in the dynamic and unconventional tic tac toe.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eI was personally responsible for designing and fabricating the drone. This involved CAD and CAM of custom carbon fiber frame, CNC milling of carbon fiber sheets under a flooded work envelope. CNC milling of polycarbonate propguards. Choosing and assembly of appropriate electronics such as power systems and flight controller onto frame. Additionally, total BOM was kept below our team‚Äôs $1200 budget as we participated as an independent team and funded the endeavour from our personal savings.\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:1313/blog/safmc2021/","title":"SAFMC Category D1 2021"},{"content":"\u003cp\u003eAwhile back I fell into the rabbit hole of mechanical keyboards and as it goes when I fall, I fall in DEEP. Fortunately, this was actually a blessing this time. The journey of most who catch the bug starts out with gaming keyboards which progress to mechanical keyboards. Then they might buy kits or keycaps and switches to make a custom keyboard. Still others design their own keyboards. Then there\u0026rsquo;s q further niche of ergonomic keyboards, starting with ortholinear keyboards, split keyboards and then split ortho column staggered keyboards.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/keyboard_meme.jpg\" alt=\"winnie the pooh meme\"\u003e\u003c/p\u003e\n\u003cp\u003eAt each step along the way adventurers usually buy a keyboard, only to discover the next level down, or up? And desire a keyboard of the next tier, always chasing the endgame keyboard. I instead took the express train down to hell and decided to go from a free membrane keyboard to a keyboard with the most keywords, a custom designed split wireless ergo low profile column staggered keyboard. üëç\u003c/p\u003e\n\u003cp\u003eThe idea was that at the time, there were barely any split keyboard that was low profile but also wireless. I only found 1 such board called the caravell, it however used the nrf series of chips which during the great chip shortage of 2021 was backordered on all major distributors for months. This promoted me to think of the ESP32 family of chips. They have built in Bluetooth and we\u0026rsquo;re widely supporte, which made me wonder why nobody has made any keyboard with these chips. Granted their efficiency is lower than the nrf family, but for a keyboard I didn\u0026rsquo;t mind chucking in a 18650 and calling it a day.\u003c/p\u003e\n\u003cp\u003eAdditionally the second major motivation for pursuing this project was my desire to improve my pcb design skills. Up till then, I had only designed small and relatively simple pcbs. Mainly breakout boards that used through hole components. I had watched many videos on SMD pcb design and therefore felt decently confident that I had the required knowledge to avoid any major pitfalls and rookie mistakes. However, nothing beats real experience. So I also treated this project as a learning experience and was willing to spend more money to invest in myself. A functional product would be the cherry on top.\u003c/p\u003e\n\u003cp\u003eI started this project as I do any project, copious amounts of research. I cloned the caravell github and looked at the general layout and architecture. I didn\u0026rsquo;t really like that it was powered by coin cells and wanted a USB rechargeable device. I targeted my next area of research to battery powered microcontroller projects. Also with it being battery powered, I wanted to have as low sleeping power or quiescent current consumption as possible. I found this video series by Andreas Speicess on esp32s and battery powered boards particularly informative.\n\u003ca href=\"https://youtube.com/playlist?list=PL3XBzmAj53RnZPeWe799F-uoXERBldhn9\u0026amp;si=yjhQitq0VkORwanx\"\u003ehttps://youtube.com/playlist?list=PL3XBzmAj53RnZPeWe799F-uoXERBldhn9\u0026amp;si=yjhQitq0VkORwanx\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eHe goes through many important considerations when designing a battery powered microcontroller board and has a super handy spreadsheet of boards and they\u0026rsquo;re quiescent current consumptions. From that list, I inspected the schematics of the boards with the highest efficiencies to figure out what chips they use. For example, the choice of LDO is especially influential on the deep sleep efficiency.  From here, I also copied the schematics of various essential blocks of components such as usb to uart chips, dual power source switching circuits etc.\u003c/p\u003e\n\u003cp\u003eI was hoping to find a LDO that was already used in an existing board which I could copy wholesale as I initally didn\u0026rsquo;t have the confidence to select the appropriate supporting passives. I looked through a couple boards but many of the popular chips used were out of stock during the chip shortage. Eventually, I found a video by Phil\u0026rsquo;s Lab which explained well how to select LDOs and construct the circuit. Afterwhich, I quickly found a suitable chip from the thousands available on mouser and digikey.\u003c/p\u003e\n\u003cp\u003eThe next major block is the ESP32 microcontroller with usb to uart chip, which was easier than usual because the ESP32 WROOM module already incoporates the crystal oscillator for the clock, the only things required were reset/boot buttons. The usb to uart block was easily lifted from other opensourced boards such as adafruits feather series. I used the cp2104 which was extremely popular with other boards. The block includes BJTs to automatically put the ESP into boot mode for programming and reset upon completion.\u003c/p\u003e\n\u003cp\u003eThe last major block was the battery charging circuit. This, I set out to design from scratch because chips and boards commonly used in hobbyist projects only had charging currents up to 1A. In an era of fast charging, how can we be content with anything less than 2A? Even if it was overkill for keyboards, it\u0026rsquo;s a matter of personal pride for me. I looked on digikey and easily found the MP2615. Which could do 1 or 2 cell charging. It even has presets for me to adjust the max voltage to 4.1 instead of 4.2 volts for battery life preservation. I rewatched a bunch of videos on buck converter design and layout to refresh my memory on switching converter design. Afterwards referring to the datasheets application note and suggested layout, I constructed the circuit in kicad.\n\u003cimg src=\"/lowravell_schematic.png\" alt=\"lowravell_schematic\"\u003e\u003c/p\u003e\n\u003cp\u003eAfter all these, it was simply a matter of connecting all blocks together. I took the caravell switch layout and increased the pinky row stagger to a full row instead of half as i felt that it was more ergonomic that way. From my research, half row pinky staggers were decended from a direct flattening of originally curved and raised ergo keyboards. I replaced all the diodes in the matrix to be SMD diodes and rerouted the matrix for the practice.\u003cbr\u003e\n\u003cimg src=\"/lowravell_layout.png\" alt=\"lowravell_layout\"\u003e\u003c/p\u003e\n\u003cp\u003eFinally, I sent the board to JLCPCB for production, ordered the BOM from digikey and some low profile choc switches. Keeping with the theme of ergonomics, I ordered light 35g linear switches.\u003c/p\u003e\n\u003cp\u003eWhile waiting for the production of the actual PCBs, I made a simple breakout board for the ESP32 dev board to a keyboard matrix. I used this to work through the firmware setup. I decided to try a port of the most popular keyboard firmware QMK for ESP32s called MK32. The official project had very limited support for wireless chipsets and only supported for the nrf series at the time. It required some finagling to get working as it was an unmaintained project. What worked in the end was using the docker image to get a specific version of ESP32IDF and flashing a particular board configuration.\u003c/p\u003e\n\u003cp\u003eAfter the pcbs came, I assembled the board but realised that i messed up in a couple of places. None were super critical but required buying new components.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eI accidentally used a totally different footprint for the LDO on the actual PCB. I initiated put a different schematic symbol as a placeholder and only renamed it but didnt change its associated footprint.\u003c/li\u003e\n\u003cli\u003eThe current shunt resistor was 0.1 Ohm vs 50mOhm. That made the battery charging current only 1A. The ic I bought was a slightly different variant in the same series that used a 50mOhm reference instead. Variants matter!\u003c/li\u003e\n\u003cli\u003eThe Schottky diode I choose for the power switching between usb and battery power was a signal diode not a power diode. The high resistance caused battery power to not work as the voltage drop across it was too high.\u003c/li\u003e\n\u003cli\u003eI somehow bought the wrong size inductor. No explanation.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eIts ok lessons learnt, in fact I was lucky that the errors didn\u0026rsquo;t cause require a new board order. I was fully expecting to have to do that. With some minor surgery and a little jank soldering, most major blocks worked. I could flash firmware onto the board, it connects by Bluetooth and actuates keys. Only the battery power didnt work because I only figured out the diode problem later on. I then bought new chips with the correct specifications and resoldered them for a completely functional board.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/lowravell.jpg\" alt=\"lowravell\"\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:1313/blog/lowravell/","title":"Split Wireless Keyboard"}]